var zForm=function(){"use strict";const t="zForms_events";class s{constructor(){this.isAvailable=this.checkStorageAvailability()}checkStorageAvailability(){try{const t="__zForms_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}}store(s){if(this.isAvailable&&0!==s.length)try{const i=[...this.retrieve(),...s].slice(-1e3);localStorage.setItem(t,JSON.stringify(i))}catch(t){}}retrieve(){if(!this.isAvailable)return[];try{const s=localStorage.getItem(t);return s?JSON.parse(s):[]}catch(t){return[]}}clear(){if(this.isAvailable)try{localStorage.removeItem(t)}catch(t){}}count(){return this.retrieve().length}}class i{constructor(t,i,e=10,n=5e3,o=!1){this.queue=[],this.sendTimer=null,this.isSending=!1,this.apiUrl=t,this.projectKey=i,this.batchSize=e,this.batchInterval=n,this.debug=o,this.storage=new s,this.loadStoredEvents(),this.startBatchTimer(),this.setupUnloadHandler()}add(t){this.queue.push(t),this.debug,this.queue.length>=this.batchSize&&this.send()}loadStoredEvents(){const t=this.storage.retrieve();t.length>0&&(this.queue.push(...t),this.storage.clear(),this.debug)}startBatchTimer(){this.sendTimer&&clearInterval(this.sendTimer),this.sendTimer=window.setInterval(()=>{this.queue.length>0&&this.send()},this.batchInterval)}async send(){if(this.isSending||0===this.queue.length)return;this.isSending=!0;const t=this.queue.splice(0,this.batchSize),s={project_key:this.projectKey,events:t};try{const t=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),keepalive:!0});if(!t.ok)throw new Error(`HTTP ${t.status}`);this.debug}catch(s){this.storage.store(t),this.queue.unshift(...t)}finally{this.isSending=!1}}sendBeacon(){if(0===this.queue.length)return;const t={project_key:this.projectKey,events:this.queue},s=new Blob([JSON.stringify(t)],{type:"application/json"});navigator.sendBeacon(this.apiUrl,s)?(this.debug,this.queue=[]):this.storage.store(this.queue)}setupUnloadHandler(){window.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.sendBeacon()}),window.addEventListener("beforeunload",()=>{this.sendBeacon()}),window.addEventListener("pagehide",()=>{this.sendBeacon()})}flush(){this.queue.length>0&&this.send()}destroy(){this.sendTimer&&(clearInterval(this.sendTimer),this.sendTimer=null),this.flush()}}class e{constructor(t){this.fieldStates=new Map,this.initialized=!1,this.config={api_url:"https://zForms.xyz/api/zForms/events",batch_size:10,batch_interval:5e3,debug:!1,...t},this.sessionId=this.generateSessionId(),this.queue=new i(this.config.api_url,this.config.project_key,this.config.batch_size,this.config.batch_interval,this.config.debug),this.init()}init(){this.initialized||("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.attachListeners()):this.attachListeners(),this.initialized=!0,this.config.debug)}attachListeners(){document.querySelectorAll("form").forEach(t=>{const s=this.getFormId(t);t.querySelectorAll('input:not([type="hidden"]):not([type="password"]), select, textarea').forEach(t=>{const i=this.getFieldId(t),e=`${s}_${i}`;this.fieldStates.set(e,{field_id:i,focus_time:null,last_event:null}),t.addEventListener("focus",()=>{this.handleFocus(s,i,e)}),t.addEventListener("blur",()=>{this.handleBlur(s,i,e)}),t.addEventListener("invalid",()=>{this.handleError(s,i)})}),t.addEventListener("submit",()=>{this.handleSubmit(s)})}),this.setupAbandonmentTracking()}handleFocus(t,s,i){const e=this.fieldStates.get(i);e&&(e.focus_time=Date.now(),e.last_event="focus",this.trackEvent({form_id:t,field_id:s,event_type:"focus",session_id:this.sessionId,timestamp:(new Date).toISOString()}))}handleBlur(t,s,i){const e=this.fieldStates.get(i);if(!e||!e.focus_time)return;const n=Date.now()-e.focus_time;e.focus_time=null,e.last_event="blur",this.trackEvent({form_id:t,field_id:s,event_type:"blur",time_spent_ms:n,session_id:this.sessionId,timestamp:(new Date).toISOString()})}handleSubmit(t){this.trackEvent({form_id:t,field_id:"__form__",event_type:"submit",session_id:this.sessionId,timestamp:(new Date).toISOString()}),this.queue.flush()}handleError(t,s){this.trackEvent({form_id:t,field_id:s,event_type:"error",session_id:this.sessionId,timestamp:(new Date).toISOString()})}setupAbandonmentTracking(){let t=!1;document.addEventListener("focusin",s=>{const i=s.target;i.matches("input, select, textarea")&&i.closest("form")&&(t=!0)},!0),window.addEventListener("beforeunload",()=>{if(!t)return;document.querySelectorAll("form").forEach(t=>{const s=this.getFormId(t);Array.from(this.fieldStates.values()).some(t=>"submit"===t.last_event)||this.trackEvent({form_id:s,field_id:"__form__",event_type:"abandon",session_id:this.sessionId,timestamp:(new Date).toISOString()})})})}trackEvent(t){this.queue.add(t)}getFormId(t){return t.id||t.getAttribute("name")||t.getAttribute("data-form-id")||`form_${Array.from(document.querySelectorAll("form")).indexOf(t)}`}getFieldId(t){return t.id||t.getAttribute("name")||t.getAttribute("data-field-id")||`field_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateSessionId(){const t=sessionStorage.getItem("zForms_session_id");if(t)return t;const s=`${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return sessionStorage.setItem("zForms_session_id",s),s}track(t,s,i){["focus","blur","submit","abandon","error"].includes(i)&&this.trackEvent({form_id:t,field_id:s,event_type:i,session_id:this.sessionId,timestamp:(new Date).toISOString()})}destroy(){this.queue.destroy(),this.fieldStates.clear(),this.initialized=!1}}const n=document.currentScript,o=null==n?void 0:n.getAttribute("data-zForms");if(o){const t=new e({project_key:o,api_url:(null==n?void 0:n.getAttribute("data-api-url"))||void 0,debug:null==n?void 0:n.hasAttribute("data-debug")});window.zForms=t,window.zFormsClass=e}else window.zForms=e;return e}();
//# sourceMappingURL=zForm.min.js.map
