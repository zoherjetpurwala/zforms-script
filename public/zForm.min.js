var zForm=function(){"use strict";const t="zForms_events";class i{constructor(){this.isAvailable=this.checkStorageAvailability()}checkStorageAvailability(){try{const t="__zForms_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch{return!1}}store(i){if(this.isAvailable&&0!==i.length)try{const e=[...this.retrieve(),...i].slice(-1e3);localStorage.setItem(t,JSON.stringify(e))}catch(t){}}retrieve(){if(!this.isAvailable)return[];try{const i=localStorage.getItem(t);return i?JSON.parse(i):[]}catch(t){return[]}}clear(){if(this.isAvailable)try{localStorage.removeItem(t)}catch(t){}}count(){return this.retrieve().length}}class e{constructor(t,e,s=10,n=5e3,o=!1){this.queue=[],this.sendTimer=null,this.isSending=!1,this.apiUrl=t,this.projectKey=e,this.batchSize=s,this.batchInterval=n,this.debug=o,this.storage=new i,this.loadStoredEvents(),this.startBatchTimer(),this.setupUnloadHandler()}add(t){this.queue.push(t),this.debug,this.queue.length>=this.batchSize&&this.send()}loadStoredEvents(){const t=this.storage.retrieve();t.length>0&&(this.queue.push(...t),this.storage.clear(),this.debug)}startBatchTimer(){this.sendTimer&&clearInterval(this.sendTimer),this.sendTimer=window.setInterval(()=>{this.queue.length>0&&this.send()},this.batchInterval)}async send(){if(this.isSending||0===this.queue.length)return;this.isSending=!0;const t=this.queue.splice(0,this.batchSize),i={project_key:this.projectKey,events:t};try{const t=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),keepalive:!0});if(!t.ok)throw new Error(`HTTP ${t.status}`);this.debug}catch(i){this.storage.store(t),this.queue.unshift(...t)}finally{this.isSending=!1}}sendBeacon(){if(0===this.queue.length)return;const t={project_key:this.projectKey,events:this.queue},i=new Blob([JSON.stringify(t)],{type:"application/json"});navigator.sendBeacon(this.apiUrl,i)?(this.debug,this.queue=[]):this.storage.store(this.queue)}setupUnloadHandler(){window.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.sendBeacon()}),window.addEventListener("beforeunload",()=>{this.sendBeacon()}),window.addEventListener("pagehide",()=>{this.sendBeacon()})}flush(){this.queue.length>0&&this.send()}destroy(){this.sendTimer&&(clearInterval(this.sendTimer),this.sendTimer=null),this.flush()}}class s{constructor(t){this.formStates=new Map,this.initialized=!1,this.mutationObserver=null,this.config={api_url:"https://zForms.xyz/api/zForms/events",batch_size:10,batch_interval:5e3,debug:!1,track_changes:!1,debounce_time:300,...t},this.sessionId=this.generateSessionId(),this.queue=new e(this.config.api_url,this.config.project_key,this.config.batch_size,this.config.batch_interval,this.config.debug),this.init()}init(){this.initialized||("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.setupTracking()):this.setupTracking(),this.initialized=!0,this.config.debug)}setupTracking(){this.attachListeners(),this.setupDynamicFormTracking(),this.setupAbandonmentTracking()}setupDynamicFormTracking(){this.mutationObserver=new MutationObserver(t=>{for(const i of t)"childList"===i.type&&i.addedNodes.length>0&&i.addedNodes.forEach(t=>{if(t instanceof HTMLFormElement)this.attachFormListeners(t);else if(t instanceof HTMLElement){t.querySelectorAll("form").forEach(t=>this.attachFormListeners(t))}})}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})}attachListeners(){document.querySelectorAll("form").forEach(t=>this.attachFormListeners(t))}attachFormListeners(t){const i=this.getFormId(t);if(this.formStates.has(i))return;const e=t.querySelectorAll('input:not([type="hidden"]):not([type="password"]), select, textarea'),s={form_id:i,field_states:new Map,submitted:!1,last_focused_field:null,total_fields:e.length};this.formStates.set(i,s),e.forEach((t,e)=>{const n=this.getFieldId(t),o=t;s.field_states.set(n,{field_id:n,focus_time:null,last_event:null,interaction_count:0,total_time_spent:0,has_value:this.hasFieldValue(o),validation_errors:0,field_element:new WeakRef(o),blur_debounce_timer:null}),t.addEventListener("focus",()=>{this.handleFocus(i,n,e)}),t.addEventListener("blur",()=>{this.handleBlur(i,n,e)}),this.config.track_changes&&t.addEventListener("change",()=>{this.handleChange(i,n)}),t.addEventListener("invalid",()=>{this.handleError(i,n)})}),t.addEventListener("submit",()=>{this.handleSubmit(i)}),this.config.debug}hasFieldValue(t){return(t instanceof HTMLInputElement||t instanceof HTMLSelectElement||t instanceof HTMLTextAreaElement)&&t.value.trim().length>0}handleFocus(t,i,e){const s=this.formStates.get(t);if(!s)return;const n=s.field_states.get(i);n&&(n.interaction_count++,n.focus_time=Date.now(),n.last_event="focus",s.last_focused_field=i,1===n.interaction_count&&this.trackEvent({form_id:t,field_id:i,event_type:"interaction",session_id:this.sessionId,timestamp:(new Date).toISOString(),metadata:{field_position:e,total_fields:s.total_fields}}),this.config.debug&&n.interaction_count)}handleBlur(t,i,e){const s=this.formStates.get(t);if(!s)return;const n=s.field_states.get(i);n&&n.focus_time&&(n.blur_debounce_timer&&clearTimeout(n.blur_debounce_timer),n.blur_debounce_timer=window.setTimeout(()=>{const o=Date.now()-n.focus_time;n.total_time_spent+=o,n.focus_time=null,n.last_event="blur",n.blur_debounce_timer=null;const a=n.field_element.deref();a&&(n.has_value=this.hasFieldValue(a)),o>500&&this.trackEvent({form_id:t,field_id:i,event_type:"blur",time_spent_ms:o,session_id:this.sessionId,timestamp:(new Date).toISOString(),metadata:{interaction_count:n.interaction_count,field_completed:n.has_value,validation_errors:n.validation_errors,field_position:e,total_fields:s.total_fields}})},this.config.debounce_time))}handleChange(t,i){const e=this.formStates.get(t);if(!e)return;const s=e.field_states.get(i);if(!s)return;const n=s.field_element.deref();if(n){const e=s.has_value;s.has_value=this.hasFieldValue(n),!e&&s.has_value&&this.trackEvent({form_id:t,field_id:i,event_type:"change",session_id:this.sessionId,timestamp:(new Date).toISOString(),metadata:{field_completed:!0}})}}handleSubmit(t){const i=this.formStates.get(t);i&&(i.submitted=!0);let e=0,s=0;i&&i.field_states.forEach(t=>{t.has_value&&e++,s+=t.interaction_count}),this.trackEvent({form_id:t,field_id:"__form__",event_type:"submit",session_id:this.sessionId,timestamp:(new Date).toISOString(),metadata:{total_fields:i?.total_fields||0,field_completed:e===(i?.total_fields||0),interaction_count:s}}),this.queue.flush()}handleError(t,i){const e=this.formStates.get(t);if(!e)return;const s=e.field_states.get(i);s&&s.validation_errors++,this.trackEvent({form_id:t,field_id:i,event_type:"error",session_id:this.sessionId,timestamp:(new Date).toISOString(),metadata:{validation_errors:s?.validation_errors||1}})}setupAbandonmentTracking(){const t=()=>{this.trackAbandonment()};document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.trackAbandonment()}),window.addEventListener("beforeunload",t),window.addEventListener("pagehide",t)}trackAbandonment(){this.formStates.forEach((t,i)=>{if(t.submitted)return;if(!t.last_focused_field)return;let e=0,s=0,n=0,o=0;t.field_states.forEach(t=>{t.has_value&&e++,s+=t.total_time_spent,n+=t.interaction_count,t.validation_errors>0&&o++});let a=0,r=0;for(const[i]of t.field_states){if(i===t.last_focused_field){a=r;break}r++}this.trackEvent({form_id:i,field_id:t.last_focused_field,event_type:"abandon",time_spent_ms:s,session_id:this.sessionId,timestamp:(new Date).toISOString(),metadata:{abandonment_field:t.last_focused_field,field_position:a,total_fields:t.total_fields,field_completed:e===t.total_fields,interaction_count:n,validation_errors:o}}),this.config.debug}),this.queue.flush()}trackEvent(t){this.queue.add(t)}getFormId(t){return t.id||t.getAttribute("name")||t.getAttribute("data-form-id")||`form_${Array.from(document.querySelectorAll("form")).indexOf(t)}`}getFieldId(t){return t.id||t.getAttribute("name")||t.getAttribute("data-field-id")||`field_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateSessionId(){const t=sessionStorage.getItem("zForms_session_id");if(t)return t;const i=`${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return sessionStorage.setItem("zForms_session_id",i),i}track(t,i,e){["focus","blur","submit","abandon","error","change","interaction"].includes(e)&&this.trackEvent({form_id:t,field_id:i,event_type:e,session_id:this.sessionId,timestamp:(new Date).toISOString()})}getSessionAnalytics(){const t=Array.from(this.formStates.values()).map(t=>{let i=0,e=0,s=0;return t.field_states.forEach(t=>{t.has_value&&i++,e+=t.interaction_count,s+=t.total_time_spent}),{form_id:t.form_id,total_fields:t.total_fields,completed_fields:i,total_interactions:e,total_time_spent:s,submitted:t.submitted}});return{session_id:this.sessionId,forms:t}}destroy(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.formStates.forEach(t=>{t.field_states.forEach(t=>{t.blur_debounce_timer&&clearTimeout(t.blur_debounce_timer)})}),this.queue.destroy(),this.formStates.clear(),this.initialized=!1,this.config.debug}}const n=document.currentScript,o=n?.getAttribute("data-zForms");if(o){const t=new s({project_key:o,api_url:n?.getAttribute("data-api-url")||void 0,debug:n?.hasAttribute("data-debug")});window.zForms=t,window.zFormsClass=s}else window.zForms=s;return s}();
